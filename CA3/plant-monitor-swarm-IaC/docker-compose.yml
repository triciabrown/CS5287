version: '3.8'

# Docker Swarm Stack for Plant Monitoring System
# Using Docker's built-in service discovery

services:
  # ============================================================================
  # ZooKeeper (Kafka dependency)
  # ============================================================================
  zookeeper:
    image: confluentinc/cp-zookeeper:7.4.0
    hostname: zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    volumes:
      - zookeeper_data:/var/lib/zookeeper/data
      - zookeeper_logs:/var/lib/zookeeper/log
    networks:
      - messagenet  # Only needs messaging network
    deploy:
      replicas: 1
      endpoint_mode: dnsrr  # DNS Round Robin - no VIP
      resources:
        limits:
          memory: 256M
        reservations:
          memory: 128M
      restart_policy:
        condition: on-failure
      labels:
        SERVICE_NAME: "zookeeper"
        SERVICE_TAGS: "infrastructure"

  # ============================================================================
  # Kafka Message Broker
  # ============================================================================
  kafka:
    image: confluentinc/cp-kafka:7.4.0
    hostname: kafka
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: 'zookeeper:2181'
      KAFKA_ADVERTISED_LISTENERS: 'PLAINTEXT://kafka:9092'
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: 'PLAINTEXT:PLAINTEXT'
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_GROUP_INITIAL_REBALANCE_DELAY_MS: 0
      KAFKA_HEAP_OPTS: '-Xmx400m -Xms400m'
    volumes:
      - kafka_data:/var/lib/kafka/data
    networks:
      - messagenet  # Only needs messaging network
    depends_on:
      - zookeeper
    deploy:
      replicas: 1
      endpoint_mode: dnsrr  # DNS Round Robin for better name resolution
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 400M
      restart_policy:
        condition: on-failure
        delay: 30s
        max_attempts: 10
        window: 300s
      labels:
        com.plant-monitor.service: "kafka"

  # ============================================================================
  # MongoDB Database
  # ============================================================================
  mongodb:
    image: mongo:6.0.4
    hostname: mongodb
    environment:
      MONGO_INITDB_ROOT_USERNAME_FILE: /run/secrets/mongo_root_username
      MONGO_INITDB_ROOT_PASSWORD_FILE: /run/secrets/mongo_root_password
      MONGO_INITDB_DATABASE: plant_monitoring
    secrets:
      - mongo_root_username
      - mongo_root_password
      - mongo_app_username
      - mongo_app_password
    configs:
      - source: mongodb_init_config
        target: /docker-entrypoint-initdb.d/init-mongo.js
    volumes:
      - mongodb_data:/data/db
      - mongodb_config:/data/configdb
    networks:
      - datanet  # Only needs data network
    command: >
      mongod 
      --wiredTigerCacheSizeGB 0.25 
      --quiet
    deploy:
      replicas: 1
      endpoint_mode: dnsrr
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M
      restart_policy:
        condition: on-failure
      labels:
        SERVICE_NAME: "mongodb"
        SERVICE_27017_NAME: "mongodb"
        SERVICE_TAGS: "database"

  # ============================================================================
  # MQTT Broker (Mosquitto)
  # ============================================================================
  mosquitto:
    image: eclipse-mosquitto:2.0
    hostname: mosquitto
    configs:
      - source: mosquitto_config
        target: /mosquitto/config/mosquitto.conf
    secrets:
      - mqtt_username
      - mqtt_password
    volumes:
      - mosquitto_data:/mosquitto/data
      - mosquitto_logs:/mosquitto/log
    networks:
      - frontnet  # Frontend network for Home Assistant
      - datanet   # Data network for Processor
    deploy:
      replicas: 1
      endpoint_mode: dnsrr
      placement:
        constraints:
          - node.labels.mqtt == true
      resources:
        limits:
          memory: 128M
        reservations:
          memory: 64M
      restart_policy:
        condition: on-failure
      labels:
        SERVICE_NAME: "mosquitto"
        SERVICE_1883_NAME: "mqtt"
        SERVICE_TAGS: "message-broker"

  # ============================================================================
  # Home Assistant
  # ============================================================================
  homeassistant:
    image: homeassistant/home-assistant:2023.8.0
    hostname: homeassistant
    ports:
      - "8123:8123"
    volumes:
      - homeassistant_config:/config
    configs:
      - source: homeassistant_config_yaml
        target: /config/configuration.yaml
    networks:
      - frontnet  # Only needs frontend network (MQTT access)
    depends_on:
      - mosquitto
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.labels.mqtt == true
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M
      restart_policy:
        condition: on-failure
      labels:
        SERVICE_NAME: "homeassistant"
        SERVICE_8123_NAME: "homeassistant-ui"

  # ============================================================================
  # Data Processor
  # ============================================================================
  processor:
    image: ${DOCKER_REGISTRY:-docker.io/triciab221}/plant-processor:v1.2.0-ca3
    hostname: processor
    environment:
      NODE_ENV: production
      NODE_OPTIONS: '--max-old-space-size=256'
      KAFKA_BROKER: 'plant-monitoring_kafka:9092'
      MONGODB_URL_FILE: /run/secrets/mongodb_connection_string
      MQTT_BROKER: 'mqtt://mosquitto:1883'
      METRICS_PORT: '9091'
    ports:
      - target: 9091
        published: 9092
        protocol: tcp
        mode: host  # Expose metrics on host node
    secrets:
      - mongodb_connection_string
    networks:
      - messagenet  # Messaging network for Kafka
      - datanet     # Data network for MongoDB and MQTT
    depends_on:
      - kafka
      - mongodb
      - mosquitto
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.labels.mqtt == true  # Keep MQTT/Home Assistant together on manager
      resources:
        limits:
          memory: 512M
        reservations:
          memory: 256M
      restart_policy:
        condition: on-failure
        delay: 30s
        max_attempts: 10
        window: 300s
      labels:
        SERVICE_NAME: "processor"
        SERVICE_TAGS: "application"

  # ============================================================================
  # Plant Sensors (SCALABLE)
  # ============================================================================
  sensor:
    image: ${DOCKER_REGISTRY:-docker.io/triciab221}/plant-sensor:v1.1.0-ca3
    environment:
      KAFKA_BROKERS: 'plant-monitoring_kafka:9092'
      SENSOR_INTERVAL: '30'
      METRICS_PORT: '9091'
      NODE_OPTIONS: '--max-old-space-size=128'
      TASK_SLOT: '{{.Task.Slot}}'
    ports:
      - target: 9091
        published: 9091
        protocol: tcp
        mode: host  # Each replica exposes metrics on its host node
    configs:
      - source: sensor_config
        target: /app/sensor-config.json
    networks:
      - messagenet  # Only needs messaging network (Kafka access)
    depends_on:
      - kafka
    deploy:
      replicas: 2
      # Let Swarm schedule across available nodes to test cross-node communication
      resources:
        limits:
          memory: 128M
        reservations:
          memory: 64M
      restart_policy:
        condition: on-failure
        delay: 30s
        max_attempts: 10
        window: 300s
      update_config:
        parallelism: 2
        delay: 5s
      labels:
        com.plant-monitor.service: "sensor"
        com.plant-monitor.scalable: "true"
        SERVICE_NAME: "sensor"
        SERVICE_TAGS: "application,scalable"

# ============================================================================
# Networks - Multi-Tier Isolation (CA3 Improvement)
# ============================================================================
networks:
  # Frontend network - Home Assistant and MQTT broker (user-facing)
  frontnet:
    driver: overlay
    driver_opts:
      encrypted: "true"
    ipam:
      driver: default
      config:
        - subnet: 10.10.1.0/24
    labels:
      tier: "frontend"
      description: "User-facing services only"
  
  # Messaging network - Kafka, ZooKeeper, Sensors (data ingestion)
  messagenet:
    driver: overlay
    driver_opts:
      encrypted: "true"
    ipam:
      driver: default
      config:
        - subnet: 10.10.2.0/24
    labels:
      tier: "messaging"
      description: "Message broker and data producers"
  
  # Data network - MongoDB, Processor, MQTT (data processing and storage)
  datanet:
    driver: overlay
    driver_opts:
      encrypted: "true"
    ipam:
      driver: default
      config:
        - subnet: 10.10.3.0/24
    labels:
      tier: "data"
      description: "Data processing and storage services"

# ============================================================================
# Volumes
# ============================================================================
volumes:
  zookeeper_data:
  zookeeper_logs:
  kafka_data:
  mongodb_data:
  mongodb_config:
  mosquitto_data:
  mosquitto_logs:
  homeassistant_config:

# ============================================================================
# Configs
# ============================================================================
configs:
  mosquitto_config:
    external: true
  mongodb_init_config:
    external: true
  homeassistant_config_yaml:
    external: true
  sensor_config:
    external: true

# ============================================================================
# Secrets
# ============================================================================
secrets:
  mongo_root_username:
    external: true
  mongo_root_password:
    external: true
  mongo_app_username:
    external: true
  mongo_app_password:
    external: true
  mongodb_connection_string:
    external: true
  mqtt_username:
    external: true
  mqtt_password:
    external: true
