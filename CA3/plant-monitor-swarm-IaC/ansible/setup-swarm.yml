---
# setup-swarm.yml
# Ansible playbook to configure Docker Swarm cluster on AWS EC2 instances
# This is run AFTER Terraform provisions the infrastructure

- name: Initialize Docker Swarm Manager
  hosts: managers
  become: yes
  gather_facts: yes
  tasks:
    - name: Wait for cloud-init to complete
      wait_for:
        path: /var/lib/cloud/instance/boot-finished
        timeout: 300
      
    - name: Ensure Docker is running
      service:
        name: docker
        state: started
        enabled: yes
    
    - name: Get network interface name
      shell: ip route get 1.1.1.1 | grep -oP 'dev \K\S+'
      register: network_interface
      changed_when: false
    
    - name: Disable TX offloading features (fix for Docker Swarm overlay UDP packet drops)
      command: ethtool -K {{ network_interface.stdout }} tso off gso off sg off
      register: ethtool_result
      failed_when: false
      changed_when: ethtool_result.rc == 0
    
    - name: Display network offload fix applied
      debug:
        msg: "Network offload features disabled on {{ network_interface.stdout }} for improved overlay network reliability"
    
    - name: Check if Swarm is already initialized
      command: docker info
      register: docker_info
      changed_when: false
      ignore_errors: yes
      become: no
    
    - name: Initialize Docker Swarm (if not already initialized)
      command: >
        docker swarm init
        --advertise-addr {{ ansible_default_ipv4.address }}
      when: "'Swarm: inactive' in docker_info.stdout"
      register: swarm_init
      become: no
    
    - name: Get manager join token
      command: docker swarm join-token manager -q
      register: manager_token
      changed_when: false
      become: no
    
    - name: Get worker join token
      command: docker swarm join-token worker -q
      register: worker_token
      changed_when: false
      become: no
    
    - name: Save join tokens
      set_fact:
        swarm_manager_token: "{{ manager_token.stdout }}"
        swarm_worker_token: "{{ worker_token.stdout }}"
        swarm_manager_ip: "{{ ansible_default_ipv4.address }}"
    
    - name: Display Swarm initialization result
      debug:
        msg: "Docker Swarm initialized on {{ inventory_hostname }}"

- name: Join Worker Nodes to Swarm
  hosts: workers
  become: yes
  gather_facts: yes
  max_fail_percentage: 25
  vars:
    ansible_become_timeout: 30
  tasks:
    - name: Wait for cloud-init to complete
      wait_for:
        path: /var/lib/cloud/instance/boot-finished
        timeout: 300
    
    - name: Wait for Docker to be installed
      wait_for:
        path: /usr/bin/docker
        timeout: 300
      register: docker_installed
    
    - name: Wait for Docker daemon to be ready
      command: docker info
      register: docker_ready
      until: docker_ready.rc == 0
      retries: 30
      delay: 10
      changed_when: false
      become: no
    
    - name: Ensure Docker is running
      service:
        name: docker
        state: started
        enabled: yes
    
    - name: Get network interface name
      shell: ip route get 1.1.1.1 | grep -oP 'dev \K\S+'
      register: network_interface
      changed_when: false
    
    - name: Disable TX offloading features (fix for Docker Swarm overlay UDP packet drops)
      command: ethtool -K {{ network_interface.stdout }} tso off gso off sg off
      register: ethtool_result
      failed_when: false
      changed_when: ethtool_result.rc == 0
    
    - name: Display network offload fix applied
      debug:
        msg: "Network offload features disabled on {{ network_interface.stdout }} for improved overlay network reliability"
    
    - name: Check if already part of a swarm
      command: docker info
      register: docker_info
      changed_when: false
      ignore_errors: yes
      become: no
    
    - name: Leave existing swarm if in wrong cluster
      command: docker swarm leave --force
      when: "'Swarm: active' in docker_info.stdout and 'Error' not in docker_info.stderr"
      ignore_errors: yes
      register: swarm_leave
      become: no
    
    - name: Re-check swarm status after leaving
      command: docker info
      register: docker_info_after_leave
      changed_when: false
      ignore_errors: yes
      when: swarm_leave is changed
      retries: 3
      delay: 5
      until: docker_info_after_leave.rc == 0 or docker_info_after_leave.rc is undefined
      become: no
    
    - name: Join swarm as worker
      command: >
        docker swarm join
        --advertise-addr {{ ansible_default_ipv4.address }}
        --token {{ hostvars[groups['managers'][0]]['swarm_worker_token'] }}
        {{ hostvars[groups['managers'][0]]['swarm_manager_ip'] }}:2377
      when: "'Swarm: inactive' in docker_info.stdout or docker_info_after_leave is changed"
      register: swarm_join
      become: no
    
    - name: Display join result
      debug:
        msg: "Worker {{ inventory_hostname }} joined swarm"

- name: Configure Swarm Cluster
  hosts: managers
  become: yes
  tasks:
    - name: Wait for all nodes to join
      pause:
        seconds: 10
    
    - name: List all swarm nodes
      command: docker node ls
      register: node_list
      changed_when: false
    
    - name: Display cluster status
      debug:
        var: node_list.stdout_lines
    
    - name: Get manager node ID
      shell: docker node ls --filter "role=manager" --format "{{"{{"}}.ID{{"}}"}}"
      register: manager_node_id
      changed_when: false
    
    - name: Label manager node for service placement
      command: >
        docker node update
        --label-add mqtt=true
        {{ manager_node_id.stdout_lines[0] }}
      when: manager_node_id.stdout_lines | length > 0
    
    - name: Display labeled node
      debug:
        msg: "Labeled manager node {{ manager_node_id.stdout_lines[0] }} with mqtt=true"
      when: manager_node_id.stdout_lines | length > 0
    
    - name: Create required directories
      file:
        path: "{{ item }}"
        state: directory
        owner: ubuntu
        group: ubuntu
        mode: '0755'
      loop:
        - /home/ubuntu/plant-monitor
        - /home/ubuntu/plant-monitor/configs
        - /home/ubuntu/plant-monitor/scripts
