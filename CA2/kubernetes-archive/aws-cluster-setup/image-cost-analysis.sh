#!/bin/bash
# image-cost-analysis.sh
# Analyze data transfer costs for different image strategies

echo "ðŸ” Container Image Data Transfer Cost Analysis"
echo "=============================================="
echo ""

echo "ðŸ“Š CURRENT DEPLOYMENT IMAGES:"
echo "-----------------------------"
echo "Large Images (>100MB):"
echo "  â€¢ homeassistant/home-assistant:2024.1.0  ~400MB"
echo "  â€¢ mongo:6.0.4                           ~150MB"
echo "  â€¢ confluentinc/cp-kafka:7.4.0           ~200MB"
echo ""
echo "Small Images (<50MB):"
echo "  â€¢ eclipse-mosquitto:2.0.18              ~30MB"
echo "  â€¢ python:3.9-alpine                     ~45MB"
echo ""
echo "AWS Optimized Images (FREE):"
echo "  â€¢ public.ecr.aws/ebs-csi-driver/*       FREE (AWS Public ECR)"
echo "  â€¢ registry.k8s.io/ingress-nginx/*       FREE (Kubernetes registry)"
echo ""

echo "ðŸ’° COST SCENARIOS (5-node cluster):"
echo "-----------------------------------"
echo ""
echo "Scenario 1: Docker Hub Only (Current)"
echo "  â€¢ Per deployment: (400+150+200+30+45) Ã— 5 nodes = ~4.1GB"
echo "  â€¢ AWS Free Tier: 1GB/month"
echo "  â€¢ Result: Exceeds limit on first deployment! ðŸ’¸"
echo ""
echo "Scenario 2: Cache Large Images to ECR + VPC Endpoints"
echo "  â€¢ First deployment: 4.1GB (one-time setup)"
echo "  â€¢ Subsequent deployments: ~150MB (only small images)"
echo "  â€¢ VPC endpoints: Pull large images through AWS private network"
echo "  â€¢ Result: 95% reduction after first deployment âœ…"
echo ""
echo "Scenario 3: Smart Hybrid (RECOMMENDED)"
echo "  â€¢ Cache only 3 largest images (750MB) to ECR"
echo "  â€¢ Keep small images (75MB) on Docker Hub"  
echo "  â€¢ Per deployment after caching: 75MB Ã— 5 = 375MB"
echo "  â€¢ Result: Stay within free tier limits! ðŸŽ¯"
echo ""

echo "ðŸŽ¯ RECOMMENDED STRATEGY:"
echo "========================"
echo "âœ… Cache these to ECR (data transfer savings):"
echo "   â€¢ homeassistant/home-assistant (400MB â†’ VPC endpoint)"
echo "   â€¢ mongo (150MB â†’ VPC endpoint)"
echo "   â€¢ confluentinc/cp-kafka (200MB â†’ VPC endpoint)"
echo ""
echo "âš¡ Keep these on Docker Hub (cost-effective):"
echo "   â€¢ eclipse-mosquitto (30MB - minimal impact)"
echo "   â€¢ python:3.9-alpine (45MB - minimal impact)"
echo ""
echo "ðŸ†“ Use AWS optimized when available:"
echo "   â€¢ public.ecr.aws/* (no data transfer charges)"
echo "   â€¢ registry.k8s.io/* (Kubernetes registry)"
echo ""

echo "ðŸ“ˆ SAVINGS CALCULATION:"
echo "======================="
echo "Before optimization:"
echo "  â€¢ 4.1GB Ã— $0.09/GB = $0.37 per deployment"
echo "  â€¢ Multiple deployments = $1.11+ (exceeds free tier)"
echo ""
echo "After smart caching:"
echo "  â€¢ Initial setup: $0.37 (one-time)"
echo "  â€¢ Ongoing deployments: $0.03 each (95% savings)"
echo "  â€¢ Monthly cost: <$0.50 (well within free tier)"
echo ""

echo "ðŸ’¡ KEY INSIGHT:"
echo "==============="
echo "Don't cache small images - Docker Hub is more cost-effective"
echo "for images under 100MB when accounting for ECR storage costs!"
echo ""
echo "ðŸš€ Implementation: Run smart-image-cache.sh"
echo "âœ… Only caches images where ECR provides clear benefit"